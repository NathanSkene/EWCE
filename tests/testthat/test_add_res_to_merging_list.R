# Test for add_res_to_merging_list, using sample data in vignette
test_that("merging EWCE results from multiple sets", {
    # load vignette data
    # Load some vignette data
    tt_alzh <- tt_alzh()
    tt_alzh_BA36 <- tt_alzh_BA36()
    tt_alzh_BA44 <- tt_alzh_BA44()
    ctd <- ctd()
    #eh <- query(ExperimentHub::ExperimentHub(), "ewceData")
    #tt_alzh <- eh[["EH5373"]]
    #tt_alzh_BA36 <- eh[["EH5374"]]
    #tt_alzh_BA44 <- eh[["EH5375"]]
    #ctd <- eh[["EH5376"]]

    # Use 10 up/down regulated genes (thresh) for speed, default is 250
    thresh = 10
    # For speed set reps to 10, for publication reps should be higher
    reps = 10

    # Run EWCE analysis
    tt_results <- ewce_expression_data(
        sct_data = ctd, tt = tt_alzh, annotLevel = 1, thresh=thresh, reps=reps,
        ttSpecies = "human", sctSpecies = "mouse"
    )
    tt_results_36 <- ewce_expression_data(
        sct_data = ctd, tt = tt_alzh_BA36,thresh=thresh, reps=reps,
        annotLevel = 1, ttSpecies = "human",
        sctSpecies = "mouse"
    )
    tt_results_44 <- ewce_expression_data(
        sct_data = ctd, tt = tt_alzh_BA44,thresh=thresh, reps=reps,
        annotLevel = 1, ttSpecies = "human",
        sctSpecies = "mouse"
    )
    # Fill a list with the results
    results <- add_res_to_merging_list(tt_results)
    results <- add_res_to_merging_list(tt_results_36, results)
    results <- add_res_to_merging_list(tt_results_44, results)

    # check some non-directional tests
    tt_results_adj <- tt_results[c(1, 2, 4)]
    names(tt_results_adj) <- c("joint_results", "hit.cells", "bootstrap_data")
    # run the undirectional
    results_adj <- add_res_to_merging_list(tt_results_adj)
    # should get error if try to combine directional with undirectional
    error_return <-
        tryCatch(add_res_to_merging_list(tt_results_36, results_adj),
            error = function(e) e,
            warning = function(w) w
        )

    # check returns
    test1 <- length(results) == 6
    # make sure all metrics returned for each
    test2 <- all.equal(
        unlist(lapply(results, function(x) names(x))),
        rep(c("Direction", "bootstrap_data", "hitCells"), 6)
    )
    # check output equal to input before combination
    test3 <- all.equal(results[[1]]$hitCells, tt_results$hit.cells.up)
    test4 <- all.equal(results[[5]]$hitCells, tt_results_44$hit.cells.up)
    test5 <- all.equal(tt_results_36$bootstrap_data.up, results[[3]]$bootstrap_data)

    # Perform the merged analysis
    merged_res <- merged_ewce(results, reps = reps)

    ewce_plot_res <- ewce_plot(merged_res)$plain
    # fail if any but ggplot returned
    test6 <- is(ewce_plot_res)[1] == "gg"


    # undirectional tests
    test7 <- length(results_adj[[1]]) == 2
    test8 <- is(error_return, "error")

    # fail if any subtest isn't true
    expect_equal(all(test1, test2, test3, test4, test5, test6, test7, test8), TRUE)
})
