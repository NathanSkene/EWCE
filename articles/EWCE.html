<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expression Weighted Celltype Enrichment with *EWCE* • EWCE (Expression Weighted Celltype Enrichment)</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Expression Weighted Celltype Enrichment with *EWCE*">
<meta property="og:description" content="EWCE">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-175929032-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-175929032-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EWCE (Expression Weighted Celltype Enrichment)</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.99.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/EWCE.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="EWCE_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Expression Weighted Celltype Enrichment with <em>EWCE</em>
</h1>
                        <h4 class="author">Alan Murphy and Nathan Skene</h4>
            
            <h4 class="date">2021-03-11</h4>
      
      
      <div class="hidden name"><code>EWCE.Rmd</code></div>

    </div>

    
    
<!-- Readme.md is generated from Readme.Rmd. Please edit that file -->
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><div id="citation" class="section level1">
<h1 class="hasAnchor">
<a href="#citation" class="anchor"></a>Citation</h1>
<p>If you use the EWCE package as well then please cite</p>
<p><a href="https://www.frontiersin.org/articles/10.3389/fnins.2016.00016/full">Skene, et al. Identification of Vulnerable Cell Types in Major Brain Disorders Using Single Cell Transcriptomes and Expression Weighted Cell Type Enrichment. Front. Neurosci, 2016.</a></p>
<p>If you use the cortex/hippocampus single cell data associated with this package then please cite the following papers:</p>
<p><a href="http://www.sciencemag.org/content/early/2015/02/18/science.aaa1934.abstract">Zeisel, et al. Cell types in the mouse cortex and hippocampus revealed by single-cell RNA-seq. Science, 2015.</a></p>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The <em>EWCE</em> package is designed to facilitate expression weighted celltype enrichment analysis as described in our Frontiers in Neuroscience paper.<span class="citation"><sup>1</sup></span></p>
<p>The package was originally designed to work with the single cell cortical transcriptome data from the Linnarsson lab<span class="citation"><sup>2</sup></span> which is available at <a href="http://linnarssonlab.org/cortex/" class="uri">http://linnarssonlab.org/cortex/</a>. Using this package it is possible to read in any single cell transcriptome data, provided that you have a cell by gene expression matrix (with each cell as a seperate column) and a seperate annotation dataframe, with a row for each cell.</p>
<p>The <em>EWCE</em> process involves testing for whether the genes in a target list have higher levels of expression in a given cell type than can reasonably be expected by chance. The probability distribution for this is estimated by randomly generating gene lists of equal length from a set of background genes.</p>
<p>The <em>EWCE</em> method can be applied to any gene list. In the paper we reported it’s application to genetic and transcriptomic datasets, and in this vignette we detail how this can be done.</p>
<p>Note that throughout this vignette we use the terms ‘cell type’ and ‘sub-cell type’ to refer to two levels of annotation of what a cell type is. This is described in further detail in our paper<span class="citation"><sup>1</sup></span>, but relates to the two levels of annotation provided in the Linnarsson dataset<span class="citation"><sup>2</sup></span>. In this dataset a cell is described as having a cell type (i.e. ‘Interneuron’) and subcell type (i.e. ‘Int11’ a.k.a Interneuron type 11).</p>
</div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>The process for using <em>EWCE</em> essentially involves three steps.</p>
<p>First, one needs to load the relevant single cell transcriptome dataset. Single cell transcriptome data is read in from a text file using the <code>read_celltype_data</code>.</p>
<p>The user then obtains a gene set and a suitable background gene set. As the choice of gene sets is up to the user we do not provide functions for doing this. Appropriate choice of background set is discussed in the associated publication.</p>
<p>Bootstrapping is then performed using the <code>bootstrap.enrichment.test</code> function.</p>
</div>
<div id="installing-ewce" class="section level1">
<h1 class="hasAnchor">
<a href="#installing-ewce" class="anchor"></a>Installing EWCE</h1>
<p>The <em>EWCE</em> package is available from github. The old version available from the Bioconductor archives is depreciated and should not be used. To be able to install the package one needs first to install R then run the following lines of code:</p>
<pre><code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("devtools")
library(devtools)
install_github("neurogenomics/EWCE")</a></code></pre>
<p>You can then load the package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">EWCE</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/">cowplot</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://bioinf.wehi.edu.au/limma">limma</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="loading-single-cell-transcriptome-data" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-single-cell-transcriptome-data" class="anchor"></a>Loading single cell transcriptome data</h1>
<div id="loading-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-datasets" class="anchor"></a>Loading datasets</h2>
<p>The first step for all analyses is to load the single cell transcriptome (SCT) data. For the purposes of this example we will use the dataset described in <em>“Cell types in the mouse cortex and hippocampus revealed by single-cell RNA-seq”, Science, 2015</em>. The following code downloads this file, passes it to the load.linnarsson.sct.data() function which extracts the expression and annotation data and returns these as a list.</p>
<p>Important note: you do NOT have to format your input single cell data like the Linnarsson data. Just read it into R such that you have an expression matrix and an annotation data frame. The three columns that you must have in the annotation data frame are “cell_id”, “level1class” and “level2class”.</p>
<pre><code><a href="https://rdrr.io/r/utils/download.file.html">download.file("goo.gl/r5Y24y",
    destfile="expression_mRNA_17-Aug-2014.txt") 

path = "expression_mRNA_17-Aug-2014.txt"

cortex_mrna  = load.linnarsson.sct.data(path)</a></code></pre>
<p>To check the data we can quickly plot the distribution of expression of a given gene across all the cell types.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">cortex_mrna</span><span class="op">)</span>
<span class="va">gene</span><span class="op">=</span><span class="st">"Necab1"</span>
<span class="va">cellExpDist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>e<span class="op">=</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span><span class="op">[</span><span class="va">gene</span>,<span class="op">]</span>,l1<span class="op">=</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">annot</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">level1class</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cellExpDist</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">l1</span>,y<span class="op">=</span><span class="va">e</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Cell type"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Unique Molecule Count"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>It is very common for publically available transcriptome datasets to use incorrect gene symbols (often some gene names will have been mangled by opening in Excel). A function is provided to correct these where out of date aliases were used and give a warning if appears possible that excel has mangled some of the gene names. The first time you run it you will need to download the MRK_List2 file from MGI which lists known synonyms for MGI gene symbols. We recommend running this on all input datasets.</p>
<pre><code>if(!file.exists("MRK_List2.rpt")){
    download.file("http://www.informatics.jax.org/downloads/reports/MRK_List2.rpt", destfile="MRK_List2.rpt")
}
cortex_mrna$exp = fix.bad.mgi.symbols(cortex_mrna$exp,mrk_file_path="MRK_List2.rpt")</code></pre>
</div>
<div id="drop-genes" class="section level2">
<h2 class="hasAnchor">
<a href="#drop-genes" class="anchor"></a>Drop genes</h2>
<p>The vignette takes a while to go through if you use all genes. So let’s restrict to 1000 random genes.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nKeep</span> <span class="op">=</span> <span class="fl">1000</span>
<span class="va">must_keep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Apoe"</span>,<span class="st">"Gfap"</span>,<span class="st">"Gapdh"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123458</span><span class="op">)</span>
<span class="va">keep_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">must_keep</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span><span class="op">)</span>,<span class="fl">997</span><span class="op">)</span><span class="op">)</span>
<span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span> <span class="op">=</span> <span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span><span class="op">[</span><span class="va">keep_genes</span>,<span class="op">]</span></code></pre></div>
</div>
<div id="transform-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#transform-the-data" class="anchor"></a>Transform the data</h2>
<p>A different number of reads is found across each cell. We suggest using scTransform to normalise for differences due to cell size, then linearly scale. Note that this might be slow.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># devtools::install_github(repo = 'ChristophH/sctransform')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ChristophH/sctransform">sctransform</a></span><span class="op">)</span>
<span class="va">scT</span> <span class="op">=</span> <span class="fu">sctransform</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sctransform/man/vst.html">vst</a></span><span class="op">(</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span>, return_cell_attr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |======================================================================| 100%
## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |======================================================================| 100%</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp_scT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sctransform/man/correct_counts.html">correct_counts</a></span><span class="op">(</span><span class="va">scT</span>, <span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp</span><span class="op">)</span> <span class="co"># umi_corrected</span></code></pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |======================================================================| 100%</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp_scT_normed</span> <span class="op">=</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp_scT</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp_scT</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Note that this is optional (and was not used in the original EWCE publication) so by all means ignore this scTransform step.</p>
</div>
<div id="calculate-specificity-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-specificity-matrices" class="anchor"></a>Calculate specificity matrices</h2>
<p>The next steps are as follows: 1) Drop genes which do not show significant evidence of varying between level 2 celltypes (based on ANOVA) 2) Calculate cell type averages and specificity for each gene 3) Drop all genes which do not have 1:1 mouse:human orthologs</p>
<p>The last step is only neccesary if you plan to compare to human data, i.e. genesets resulting from human genetics.</p>
<p>Rather than returning the data directly, the functions save the calculated data to a file and the filename is returned.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Generate celltype data for just the cortex/hippocampus data</span>
<span class="va">exp_CortexOnly_DROPPED</span> <span class="op">=</span> <span class="fu"><a href="../reference/drop.uninformative.genes.html">drop.uninformative.genes</a></span><span class="op">(</span>exp<span class="op">=</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">exp_scT_normed</span>,level2annot <span class="op">=</span> <span class="va">cortex_mrna</span><span class="op">$</span><span class="va">annot</span><span class="op">$</span><span class="va">level2class</span><span class="op">)</span>
<span class="va">annotLevels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level1class<span class="op">=</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">annot</span><span class="op">$</span><span class="va">level1class</span>,level2class<span class="op">=</span><span class="va">cortex_mrna</span><span class="op">$</span><span class="va">annot</span><span class="op">$</span><span class="va">level2class</span><span class="op">)</span>
<span class="va">fNames_CortexOnly</span> <span class="op">=</span> <span class="fu"><a href="../reference/generate.celltype.data.html">generate.celltype.data</a></span><span class="op">(</span>exp<span class="op">=</span><span class="va">exp_CortexOnly_DROPPED</span>,annotLevels<span class="op">=</span><span class="va">annotLevels</span>,groupName<span class="op">=</span><span class="st">"kiCortexOnly"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fNames_CortexOnly</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "~//CellTypeData_kiCortexOnly.rda"</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fNames_CortexOnly</span> <span class="op">=</span> <span class="fu"><a href="../reference/filter.genes.without.1to1.homolog.html">filter.genes.without.1to1.homolog</a></span><span class="op">(</span><span class="va">fNames_CortexOnly</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fNames_CortexOnly</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "~//CellTypeData_kiCortexOnly.rda"         
## [2] "~//CellTypeData_kiCortexOnly_1to1only.rda"</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="va">fNames_CortexOnly</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div id="merging-two-single-cell-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#merging-two-single-cell-datasets" class="anchor"></a>Merging two single cell datasets</h2>
<p>Often it is useful to merge two single cell datasets. For instance, there are seperate files for the cortex and hypothalamus datasets generated by the Karolinska. This dataset is first downloaded from GEO, unzipped and read into R. Because the file is in xlsx format you may need to install the readxl package. So first we just read in and prepare the expression matrix and annotation data frame:</p>
<pre><code># Download the hypothalamus data and unzip
if(!file.exists("GSE74672_expressed_mols_with_classes.xlsx")){
    download.file("ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE74nnn/GSE74672/suppl/GSE74672_expressed_mols_with_classes.xlsx.gz", destfile="GSE74672_expressed_mols_with_classes.xlsx.gz")
    system("gunzip GSE74672_expressed_mols_with_classes.xlsx.gz")
}

# Read in the hypothalamus data
hypo_dat = read_excel("GSE74672_expressed_mols_with_classes.xlsx")

# Extract the expression data, gene symbols and annotation data
exp = data.matrix(hypo_dat[12:dim(hypo_dat)[1],2:dim(hypo_dat)[2]])
rownames(exp) = data.frame(hypo_dat[12:dim(hypo_dat)[1],1])[,1]
level1class = data.frame(level1class=t(hypo_dat[1,2:dim(hypo_dat)[2]]),stringsAsFactors = FALSE)[,1]
level2class = data.frame(leve2class=t(hypo_dat[2,2:dim(hypo_dat)[2]]),stringsAsFactors = FALSE)[,1]
cell_id     = colnames(hypo_dat)[2:dim(hypo_dat)[2]]
hypo_annot  = data.frame(cell_id=cell_id,level1class=level1class,level2class=level2class,stringsAsFactors = FALSE)

# Drop the glia and unclassified cells (which don't have level 2  annotations)
hypo_annot  = hypo_annot[!is.na(hypo_annot$level2class) &amp; !hypo_annot$level2class=="uc",]
hypo_exp    = exp[,hypo_annot$cell_id]

# Make the celltype names more aesthetically pleasing
hypo_annot$level2class=gsub(",",";",hypo_annot$level2class)
hypo_annot$level1class[grep("Oxt;|^Avp",hypo_annot$level2class)] = "Oxytocin / Vasopressin Expressing Neurons"
hypo_annot$level1class[grep("^Th;|^Dopamine",hypo_annot$level2class)] = "Hypothalamic Dopaminergic Neurons"
hypo_annot$level1class[grepl("^Vglut2|^Trh|^Qrfp|^Hcrt|^Pmch|^Adcyap1|^Npvf|^Ghrh|^Hmit|^Nms|^Vip;|^Per2|Tnr$|^Gad-low;Gnrh",hypo_annot$level2class) &amp; grepl("neurons",hypo_annot$level1class)] = "Hypothalamic Glutamatergic Neurons"
hypo_annot$level1class[grepl("GABA|^Sst|^Crh|^Npy|^Pomc|^Galanin|^Otof|Pnoc$|^Calcr-high",hypo_annot$level2class) &amp; grepl("^neurons$",hypo_annot$level1class)] = "Hypothalamic GABAergic Neurons"
hypo_annot$level2class[hypo_annot$level2class!=""] = sprintf("Hypothalamic %s Neuron",hypo_annot$level2class[hypo_annot$level2class!=""])

# Fix bad MGI symbols
hypo_exp_CORRECTED = fix.bad.mgi.symbols(hypo_exp)</code></pre>
<p>Now that the hypothalamus data is prepared, we merge it with the cortex dataset then calculate specificity:</p>
<pre><code># Merge the datasets
merged_KI = merge_two_expfiles(exp1=hypo_exp_CORRECTED,  exp2=cortex_mrna$exp,
                                     annot1=hypo_annot,        annot2=cortex_mrna$annot,
                                     name1="Hypothalamus (KI)", name2="Cortex/Hippo (KI)")

# Drop genes which don't vary significantly between cell types
exp_merged_DROPPED = drop.uninformative.genes(exp=merged_KI$exp, level2annot = merged_KI$annot$level2class)

# Calculate specificity data
annotLevels = list(level1class=merged_KI$annot$level1class,level2class=merged_KI$annot$level2class)
fNames_MergedKI = generate.celltype.data(exp=exp_merged_DROPPED,annotLevels,"MergedKI")
fNames_MergedKI = filter.genes.without.1to1.homolog(fNames_MergedKI)
load(fNames_MergedKI[2])</code></pre>
</div>
<div id="understanding-specificity-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#understanding-specificity-matrices" class="anchor"></a>Understanding specificity matrices</h2>
<p>While not required for further analyses it helps to understand what the outputs of this function are.</p>
<p>Note firstly, that it is a list such that ctd[[1]] contains data relating to level 1 annotations and ctd[[2]] relates to level 2 annotations.</p>
<p>Using the ggplot2 package to visualise the data, let us examine the expression of a few genes. If you have not already done so you will need to first install the ggplot2 package with <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("ggplot2")</a></code>.</p>
<p>For this example we use a subset of the genes from the merged dataset generated above, which is accessed using <code><a href="https://rdrr.io/r/utils/data.html">data(ctd)</a></code>. We recommend that you use the code above to regenerate this though and drop the <code>data</code> command from the below section.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"ctd"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape">reshape2</a></span><span class="op">)</span>
<span class="va">genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Apoe"</span>,<span class="st">"Gfap"</span>,<span class="st">"Gapdh"</span><span class="op">)</span>
<span class="va">exp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/cbind.html">cbind</a></span><span class="op">(</span><span class="va">ctd</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mean_exp</span><span class="op">[</span><span class="va">genes</span>,<span class="op">]</span>,<span class="va">genes</span><span class="op">)</span>,id.vars<span class="op">=</span><span class="st">"genes"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Gene"</span>,<span class="st">"Cell"</span>,<span class="st">"AvgExp"</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Cell</span>,y<span class="op">=</span><span class="va">AvgExp</span><span class="op">)</span>,stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">Gene</span><span class="op">~</span><span class="va">.</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>This graph shows the average expression of three genes: <em>Apoe, Gfap</em> and <em>Gapdh</em>. While there are substantial differences in which cell types express these genes, the dominant effect seen here is the overall expression level of the data. For the purposes of this analysis though, we are not interested in overall expression level and only wish to know about the proportion of a genes expression which is found in a particular celltype. We can study this instead using the following code which examines the data frame <em>ctd[[1]]$specificity</em>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">exp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">ctd</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">specificity</span><span class="op">[</span><span class="va">genes</span>,<span class="op">]</span><span class="op">)</span>,<span class="va">genes</span><span class="op">)</span>,id.vars<span class="op">=</span><span class="st">"genes"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Gene"</span>,<span class="st">"Cell"</span>,<span class="st">"Expression"</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Cell</span>,y<span class="op">=</span><span class="va">Expression</span><span class="op">)</span>,stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">Gene</span><span class="op">~</span><span class="va">.</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>We can now see in this graph that <em>Gfap</em> is the most specific to a cell type (Type 1 Astrocytes) of either of those three genes, with over 60% of it’s expression found in that cell type.</p>
<p>It can also be seen that the majority of expression of Gapdh is in neurons but because their are a greater number of neuronal subtypes, the total expression proportion appears lower. We can examine expression across level 2 celltype level annotations by looking at <em>ctd[[2]]$specificity</em>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">exp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">ctd</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">specificity</span><span class="op">[</span><span class="va">genes</span>,<span class="op">]</span><span class="op">)</span>,<span class="va">genes</span><span class="op">)</span>,id.vars<span class="op">=</span><span class="st">"genes"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Gene"</span>,<span class="st">"Cell"</span>,<span class="st">"Specificity"</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Cell</span>,y<span class="op">=</span><span class="va">Specificity</span><span class="op">)</span>,stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">Gene</span><span class="op">~</span><span class="va">.</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
</div>
<div id="application-to-genetic-data" class="section level1">
<h1 class="hasAnchor">
<a href="#application-to-genetic-data" class="anchor"></a>Application to genetic data</h1>
<div id="preparing-gene-lists" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-gene-lists" class="anchor"></a>Preparing gene lists</h2>
<p>For the first demonstration of EWCE we will test for whether genes that are genetically associated with Alzheimer’s disease are enriched in any particular celltype. This gene list is stored within the package are we access it by first loading the package and then the dataset:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">example_genelist</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">example_genelist</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "APOE"     "BIN1"     "CLU"      "ABCA7"    "CR1"      "PICALM"  
##  [7] "MS4A6A"   "CD33"     "MS4A4E"   "CD2AP"    "EOGA1"    "INPP5D"  
## [13] "MEF2C"    "HLA-DRB5" "ZCWPW1"   "NME8"     "PTK2B"    "CELF1"   
## [19] "SORL1"    "FERMT2"   "SLC24A4"  "CASS4"</code></pre>
<p>All gene IDs are assumed by the package to be provided in gene symbol format (rather than Ensembl/Entrez). Symbols can be provided as either HGNC or MGI symbols, though the genelistSpecies argument will need to be set appropriately. Likewise, the single cell dataset can use either human or mouse gene symbols, but the sctSpecies argument must be set to either “human” or “mouse”. The default species for both is mouse.</p>
<p>The example gene list here stores the human genes associated with disease, and hence are HGNC symbols.</p>
<p>The next step is to determine the most suitable background set. The experimental methods used to find these gene are all genome wide, so there is no restriction imposed as a result of that. Thus our initial background set is the set of all human genes. Not all human genes have mouse orthologs however, so we need to drop all genes from the target and background set which do not have mouse orthologs. To save repeatedly querying biomaRt we have a stored dataset containing all the human orthologs of MGI genes, <code>mouse_to_human_homologs</code>. We can use this to obtain the mouse orthologs of the target and background genes at the same time as we drop genes without orthologs:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"mouse_to_human_homologs"</span><span class="op">)</span>
<span class="va">m2h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">mouse_to_human_homologs</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HGNC.symbol"</span>,<span class="st">"MGI.symbol"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">mouse.hits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">[</span><span class="va">m2h</span><span class="op">$</span><span class="va">HGNC.symbol</span> <span class="op">%in%</span> <span class="va">example_genelist</span>,<span class="st">"MGI.symbol"</span><span class="op">]</span><span class="op">)</span>
<span class="co">#mouse.bg  = unique(setdiff(m2h$MGI.symbol,mouse.hits))</span>
<span class="va">mouse.bg</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">$</span><span class="va">MGI.symbol</span><span class="op">)</span></code></pre></div>
<p>The target list is now converted to MGI symbols:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mouse.hits</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "Apoe"    "Inpp5d"  "Cd2ap"   "Nme8"    "Cass4"   "Mef2c"   "Zcwpw1" 
##  [8] "Bin1"    "Clu"     "Celf1"   "Abca7"   "Slc24a4" "Ptk2b"   "Picalm" 
## [15] "Fermt2"  "Sorl1"</code></pre>
<p>And we have 15604 genes in background set.</p>
</div>
<div id="setting-analysis-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-analysis-parameters" class="anchor"></a>Setting analysis parameters</h2>
<p>We now need to set the parameters for the analysis. For a publishable analysis we would want to generate over 10000 random lists and determine their expression levels, but for computational speed let us only use <code>reps=100</code>. We want to analyse level 1 annotations so set level to 1.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reps</span><span class="op">=</span><span class="fl">100</span> <span class="co"># &lt;- Use 100 bootstrap lists so it runs quickly, for publishable analysis use &gt;10000</span>
<span class="va">level</span><span class="op">=</span><span class="fl">1</span> <span class="co"># &lt;- Use level 1 annotations (i.e. Interneurons)</span></code></pre></div>
</div>
<div id="running-ewce-analysis-on-genetic-data" class="section level2">
<h2 class="hasAnchor">
<a href="#running-ewce-analysis-on-genetic-data" class="anchor"></a>Running EWCE analysis on genetic data</h2>
<p>We have now loaded the SCT data, prepared the gene lists and set the parameters. We run the model as follows:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Bootstrap significance testing, without controlling for transcript length and GC content</span>
<span class="va">full_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">mouse.hits</span>,bg<span class="op">=</span><span class="va">mouse.bg</span>,
                                reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="va">level</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "Apoe"    "Inpp5d"  "Cd2ap"   "Nme8"    "Cass4"   "Mef2c"   "Zcwpw1" 
##  [8] "Bin1"    "Clu"     "Celf1"   "Abca7"   "Slc24a4" "Ptk2b"   "Picalm" 
## [15] "Fermt2"  "Sorl1"  
## [1] "astrocytes_ependymal"
## [1] 0.13
## [1] ""
## [1] "endothelial-mural"
## [1] 0.73
## [1] ""
## [1] "interneurons"
## [1] 1
## [1] ""
## [1] "microglia"
## [1] 0.03
## [1] "Fold enrichment: 1.6545449352309"
## [1] "Standard deviations from mean: 2.1707880102352"
## [1] ""
## [1] "oligodendrocytes"
## [1] 0.72
## [1] ""
## [1] "pyramidal CA1"
## [1] 0.63
## [1] ""
## [1] "pyramidal SS"
## [1] 0.74
## [1] ""</code></pre>
<p>The main table of results is stored in <code>full_results$results</code>. We can see the most significant results using:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">full_results</span><span class="op">$</span><span class="va">results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">full_results</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">p</span><span class="op">)</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,<span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##                         p fold_change sd_from_mean
## microglia            0.03   1.6545449    2.1707880
## astrocytes_ependymal 0.13   1.3475807    1.3843592
## pyramidal CA1        0.63   0.9220466   -0.4445422
## oligodendrocytes     0.72   0.8668226   -0.5420131
## endothelial-mural    0.73   0.8553370   -0.6302660
## pyramidal SS         0.74   0.8852074   -0.6913500</code></pre>
<p>The results can be visualised using another function, which shows for each cell type, the number of standard deviations from the mean the level of expression was found to be in the target gene list, relative to the bootstrapped mean:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span><span class="va">full_results</span><span class="op">$</span><span class="va">results</span>,mtc_method<span class="op">=</span><span class="st">"BH"</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>For publications it can be useful to plot a dendrogram alongside the plot. This can be done by including the cell type data as an additional argument. There is no automated way to align the dendrogram (that I’ve figured out yet) with the graph ticks, so this needs to be done manually in Inkscape.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span><span class="va">full_results</span><span class="op">$</span><span class="va">results</span>,mtc_method<span class="op">=</span><span class="st">"BH"</span>,ctd<span class="op">=</span><span class="va">ctd</span><span class="op">)</span><span class="op">$</span><span class="va">withDendro</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>If you want to view the characteristics of enrichment for each gene within the list then the <code>generate.bootstrap.plots</code> function should be used. This saves the plots into the BootstrapPlots folder. This takes the results of a bootstrapping analysis so as to only generate plots for significant enrichments. The <code>listFileName</code> argument is used to give the generated graphs a particular file name.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/generate.bootstrap.plots.html">generate.bootstrap.plots</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">mouse.hits</span>,bg<span class="op">=</span><span class="va">mouse.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,full_results<span class="op">=</span><span class="va">full_results</span>,listFileName<span class="op">=</span><span class="st">"VignetteGraphs"</span><span class="op">)</span></code></pre></div>
</div>
<div id="running-ewce-analysis-on-genetic-data-with-controls-for-transcript-length-and-gc-content" class="section level2">
<h2 class="hasAnchor">
<a href="#running-ewce-analysis-on-genetic-data-with-controls-for-transcript-length-and-gc-content" class="anchor"></a>Running EWCE analysis on genetic data with controls for transcript length and GC-content</h2>
<p>When analysing genes found through genetic association studies it is important to consider biases which might be introduced as a result of transcript length and GC-content. The package can control for these by selecting the bootstrap lists such that the <em>i<sup>th</sup></em> gene in the random list has properties similar to the<em>i<sup>th</sup></em> gene in the target list. To enable the algorithm to do this it needs to be passed the gene lists as HGNC symbols rather than MGI.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#human.hits = unique(m2h[m2h$HGNC.symbol %in% example_genelist,"HGNC.symbol"])</span>
<span class="co">#human.bg = unique(setdiff(m2h$HGNC.symbol,human.hits))</span>
<span class="va">human.hits</span> <span class="op">=</span> <span class="va">example_genelist</span>
<span class="va">human.bg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">human.hits</span>,<span class="va">m2h</span><span class="op">$</span><span class="va">HGNC.symbol</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The bootstrapping function then takes different arguments:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Bootstrap significance testing controlling for transcript length and GC content</span>
<span class="va">cont_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">human.hits</span>,
                    bg<span class="op">=</span><span class="va">human.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,geneSizeControl<span class="op">=</span><span class="cn">TRUE</span>,genelistSpecies<span class="op">=</span><span class="st">"human"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span></code></pre></div>
<p>We plot these results using <code>ewce.plot</code>:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span><span class="va">cont_results</span><span class="op">$</span><span class="va">results</span>,mtc_method<span class="op">=</span><span class="st">"BH"</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>This shows that the controlled method generates enrichments that are generally comparable to the standard method.</p>
</div>
<div id="running-ewce-analysis-on-cell-type-level-annotations" class="section level2">
<h2 class="hasAnchor">
<a href="#running-ewce-analysis-on-cell-type-level-annotations" class="anchor"></a>Running EWCE analysis on cell type level annotations</h2>
<p>Both the analyses shown above were run on level 1 annotations. It is possible to test on the level 2 cell type level annotations by changing one of the arguments.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Bootstrap significance testing controlling for transcript length and GC content</span>
<span class="va">cont_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">human.hits</span>,
                    bg<span class="op">=</span><span class="va">human.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">2</span>,geneSizeControl<span class="op">=</span><span class="cn">TRUE</span>,genelistSpecies<span class="op">=</span><span class="st">"human"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span><span class="va">cont_results</span><span class="op">$</span><span class="va">results</span>,mtc_method<span class="op">=</span><span class="st">"BH"</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-21-1.png" width="768"></p>
<p>With the subcell analysis each microglial subtype was enriched and correspondingly we see here that the microglial celltype is enriched.</p>
</div>
<div id="plotting-results-from-multiple-gene-lists" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-results-from-multiple-gene-lists" class="anchor"></a>Plotting results from multiple gene lists</h2>
<p>It is often useful to plot results from multiple gene list analyses together. The <code>ewce.plot</code> function allows multiple enrichment analyses to be performed together. To achieve this the results data frames are just appended onto each other, with an additional <code>list</code> column added detailing which analysis they relate to.</p>
<p>To demonstrate this we need to first generate a second analysis so let us sample thirty random genes, and run the bootstrapping analysis on it.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gene.list.2</span> <span class="op">=</span> <span class="va">mouse.bg</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>
<span class="va">second_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">gene.list.2</span>,
                    bg<span class="op">=</span><span class="va">mouse.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "Rcl1"   "Myom1"  "Gpr12"  "Micu2"  "Pds5b"  "Jagn1"  "Rbm17"  "Trib2" 
##  [9] "Theg"   "Itpr1"  "Prmt5"  "Usp6nl" "Fgf9"   "Map1a"  "Samd11" "Noc2l" 
## [1] "astrocytes_ependymal"
## [1] 0.94
## [1] ""
## [1] "endothelial-mural"
## [1] 0.15
## [1] ""
## [1] "interneurons"
## [1] 0.23
## [1] ""
## [1] "microglia"
## [1] 0.82
## [1] ""
## [1] "oligodendrocytes"
## [1] 0.7
## [1] ""
## [1] "pyramidal CA1"
## [1] 0.35
## [1] ""
## [1] "pyramidal SS"
## [1] 0.04
## [1] "Fold enrichment: 1.33359715224121"
## [1] "Standard deviations from mean: 2.00794278588598"
## [1] ""</code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_res2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">full_results</span><span class="op">$</span><span class="va">results</span>,list<span class="op">=</span><span class="st">"Alzheimers"</span><span class="op">)</span>
<span class="va">scnd_res2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">second_results</span><span class="op">$</span><span class="va">results</span>,list<span class="op">=</span><span class="st">"Second"</span><span class="op">)</span>
<span class="va">merged_results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">full_res2</span>,<span class="va">scnd_res2</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span>total_res<span class="op">=</span><span class="va">merged_results</span>,mtc_method<span class="op">=</span><span class="st">"BH"</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<p>As expected, the second randomly generated gene list shows no significant enrichments.</p>
</div>
</div>
<div id="application-to-transcriptomic-data" class="section level1">
<h1 class="hasAnchor">
<a href="#application-to-transcriptomic-data" class="anchor"></a>Application to transcriptomic data</h1>
<div id="analysing-single-transcriptome-study" class="section level2">
<h2 class="hasAnchor">
<a href="#analysing-single-transcriptome-study" class="anchor"></a>Analysing single transcriptome study</h2>
<p>For the prior analyses the gene lists were not associated with any numeric values or directionality. The methodology for extending this form of analysis to transcriptomic studies simply involves thresholding the most upregulated and downregulated genes.</p>
<p>To demonstrate this we have an example dataset <code>tt_alzh</code>. This data frame was generated using limma from a set of post-mortem tissue samples from brodmann area 46 which were described in a paper by the Haroutunian lab<span class="citation"><sup>3</sup></span>.</p>
<p>The first step is to load the data, obtain the MGI ids, sort the rows by t-statistic and then select the most up/down-regulated genes. The package then has a function <code>ewce_expression_data</code> which thresholds and selects the gene sets, and calls the EWCE function. Below we show the function call using the default settings, but if desired different threshold values can be used, or alternative columns used to sort the table.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tt_alzh</span><span class="op">)</span>
<span class="va">tt_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/ewce_expression_data.html">ewce_expression_data</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,tt<span class="op">=</span><span class="va">tt_alzh</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,ttSpecies<span class="op">=</span><span class="st">"human"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span></code></pre></div>
<p>The results of this analysis can again be plotted using the <code>ewce.plot</code> function.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span><span class="va">tt_results</span><span class="op">$</span><span class="va">joint_results</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>As was reported in our paper, neuronal genes are found to be downregulated while glial genes are upregulated.</p>
</div>
<div id="generating-bootstrap-plots-for-transcriptomes" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-bootstrap-plots-for-transcriptomes" class="anchor"></a>Generating bootstrap plots for transcriptomes</h2>
<p>A common request is to explain which differentially expressed genes are associated with a cell type…</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/generate.bootstrap.plots.for.transcriptome.html">generate.bootstrap.plots.for.transcriptome</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,tt<span class="op">=</span><span class="va">tt_alzh</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,
  full_results<span class="op">=</span><span class="va">tt_results</span>,listFileName<span class="op">=</span><span class="st">"examples"</span>,reps<span class="op">=</span><span class="va">reps</span>,ttSpecies<span class="op">=</span><span class="st">"human"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span>,onlySignif<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="merging-multiple-transcriptome-studies" class="section level2">
<h2 class="hasAnchor">
<a href="#merging-multiple-transcriptome-studies" class="anchor"></a>Merging multiple transcriptome studies</h2>
<p>Where multiple transcriptomic studies have been performed with the same purpose, i.e. seeking differential expression in dlPFC of post-mortem schizophrenics, it is common to want to determine whether they exhibit any shared signal. EWCE can be used to merge the results of multiple studies.</p>
<p>To demonstrate this we use a two further Alzheimer’s transcriptome dataset coming from Brodmann areas 36 and 44: these area stored in <code>tt_alzh_BA36</code> and <code>tt_alzh_BA44</code>. The first step is to run EWCE on each of these individually and store the output into one list.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load the data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tt_alzh_BA36</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tt_alzh_BA44</span><span class="op">)</span>

<span class="co"># Run EWCE analysis</span>
<span class="va">tt_results_36</span> <span class="op">=</span> <span class="fu"><a href="../reference/ewce_expression_data.html">ewce_expression_data</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,tt<span class="op">=</span><span class="va">tt_alzh_BA36</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,ttSpecies<span class="op">=</span><span class="st">"human"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span>
<span class="va">tt_results_44</span> <span class="op">=</span> <span class="fu"><a href="../reference/ewce_expression_data.html">ewce_expression_data</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,tt<span class="op">=</span><span class="va">tt_alzh_BA44</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,ttSpecies<span class="op">=</span><span class="st">"human"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span>

<span class="co"># Fill a list with the results</span>
<span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="../reference/add.res.to.merging.list.html">add.res.to.merging.list</a></span><span class="op">(</span><span class="va">tt_results</span><span class="op">)</span>
<span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="../reference/add.res.to.merging.list.html">add.res.to.merging.list</a></span><span class="op">(</span><span class="va">tt_results_36</span>,<span class="va">results</span><span class="op">)</span>
<span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="../reference/add.res.to.merging.list.html">add.res.to.merging.list</a></span><span class="op">(</span><span class="va">tt_results_44</span>,<span class="va">results</span><span class="op">)</span>

<span class="co"># Perform the merged analysis</span>
<span class="va">merged_res</span> <span class="op">=</span> <span class="fu"><a href="../reference/merged_ewce.html">merged_ewce</a></span><span class="op">(</span><span class="va">results</span>,reps<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="co"># &lt;- For publication reps should be higher</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">merged_res</span><span class="op">)</span></code></pre></div>
<p>The results can then be plotted as normal using the <code>ewce.plot</code> function.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span><span class="va">merged_res</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-28-1.png" width="672"></p>
<p>The merged results from all three Alzheimer’s brain regions are found to be remarkably similar, as was reported in our paper.</p>
</div>
</div>
<div id="conditional-cell-type-enrichment-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#conditional-cell-type-enrichment-analysis" class="anchor"></a>Conditional cell type enrichment analysis</h1>
<div id="controlling-for-expression-in-another-cell-type" class="section level2">
<h2 class="hasAnchor">
<a href="#controlling-for-expression-in-another-cell-type" class="anchor"></a>Controlling for expression in another cell type</h2>
<p>In a followup paper we found that an enrichment detected for Schizophrenia in Somatosensory Pyramidal neurons could be explained by accounting for expression in Hippocampal CA1 pyramidal neurons. These results are described here:</p>
<p><a href="https://www.nature.com/articles/s41588-018-0129-5">Skene, et al. Genetic identification of brain cell types underlying schizophrenia. Nature Genetics, 2018.</a></p>
<p>Those results were generated using an alternative enrichment method designed for use with GWAS Summary Statistics rather than gene sets. The same sort of approach can be extended to EWCE as well, and we have implemented it within this package. When testing for enrichment the other gene sets that are sampled are selected to have equivilent specificity in the controlled celltype.</p>
<p>We demonstrate it’s use below to test whether the enrichment in astrocytes is still present after controlling for the enrichment within microglia:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"mouse_to_human_homologs"</span><span class="op">)</span>
<span class="va">m2h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">mouse_to_human_homologs</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HGNC.symbol"</span>,<span class="st">"MGI.symbol"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">mouse.hits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">[</span><span class="va">m2h</span><span class="op">$</span><span class="va">HGNC.symbol</span> <span class="op">%in%</span> <span class="va">example_genelist</span>,<span class="st">"MGI.symbol"</span><span class="op">]</span><span class="op">)</span>
<span class="va">mouse.bg</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">$</span><span class="va">MGI.symbol</span><span class="op">)</span>

<span class="va">reps</span><span class="op">=</span><span class="va">reps</span>
<span class="va">unconditional_results</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">mouse.hits</span>,
                    bg<span class="op">=</span><span class="va">mouse.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,genelistSpecies<span class="op">=</span><span class="st">"mouse"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "Apoe"    "Inpp5d"  "Cd2ap"   "Nme8"    "Cass4"   "Mef2c"   "Zcwpw1" 
##  [8] "Bin1"    "Clu"     "Celf1"   "Abca7"   "Slc24a4" "Ptk2b"   "Picalm" 
## [15] "Fermt2"  "Sorl1"  
## [1] "astrocytes_ependymal"
## [1] 0.08
## [1] ""
## [1] "endothelial-mural"
## [1] 0.74
## [1] ""
## [1] "interneurons"
## [1] 1
## [1] ""
## [1] "microglia"
## [1] 0.03
## [1] "Fold enrichment: 1.58825573596182"
## [1] "Standard deviations from mean: 2.04435420176289"
## [1] ""
## [1] "oligodendrocytes"
## [1] 0.73
## [1] ""
## [1] "pyramidal CA1"
## [1] 0.64
## [1] ""
## [1] "pyramidal SS"
## [1] 0.7
## [1] ""</code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">conditional_results_micro</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">mouse.hits</span>,
                    bg<span class="op">=</span><span class="va">mouse.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,controlledCT<span class="op">=</span><span class="st">"microglia"</span>,genelistSpecies<span class="op">=</span><span class="st">"mouse"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "Apoe"    "Inpp5d"  "Cd2ap"   "Nme8"    "Cass4"   "Mef2c"   "Zcwpw1" 
##  [8] "Bin1"    "Clu"     "Celf1"   "Abca7"   "Slc24a4" "Ptk2b"   "Picalm" 
## [15] "Fermt2"  "Sorl1"  
## [1] "astrocytes_ependymal"
## [1] 0.02
## [1] "Fold enrichment: 1.45889487273529"
## [1] "Standard deviations from mean: 2.17523402546026"
## [1] ""
## [1] "endothelial-mural"
## [1] 0.72
## [1] ""
## [1] "interneurons"
## [1] 1
## [1] ""
## [1] "microglia"
## [1] 0.64
## [1] ""
## [1] "oligodendrocytes"
## [1] 0.59
## [1] ""
## [1] "pyramidal CA1"
## [1] 0.22
## [1] ""
## [1] "pyramidal SS"
## [1] 0.3
## [1] ""</code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">conditional_results_astro</span> <span class="op">=</span> <span class="fu"><a href="../reference/bootstrap.enrichment.test.html">bootstrap.enrichment.test</a></span><span class="op">(</span>sct_data<span class="op">=</span><span class="va">ctd</span>,hits<span class="op">=</span><span class="va">mouse.hits</span>,
                    bg<span class="op">=</span><span class="va">mouse.bg</span>,reps<span class="op">=</span><span class="va">reps</span>,annotLevel<span class="op">=</span><span class="fl">1</span>,controlledCT<span class="op">=</span><span class="st">"astrocytes_ependymal"</span>,genelistSpecies<span class="op">=</span><span class="st">"mouse"</span>,sctSpecies<span class="op">=</span><span class="st">"mouse"</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "Apoe"    "Inpp5d"  "Cd2ap"   "Nme8"    "Cass4"   "Mef2c"   "Zcwpw1" 
##  [8] "Bin1"    "Clu"     "Celf1"   "Abca7"   "Slc24a4" "Ptk2b"   "Picalm" 
## [15] "Fermt2"  "Sorl1"  
## [1] "astrocytes_ependymal"
## [1] 0.41
## [1] ""
## [1] "endothelial-mural"
## [1] 0.62
## [1] ""
## [1] "interneurons"
## [1] 1
## [1] ""
## [1] "microglia"
## [1] 0
## [1] "Fold enrichment: 1.70073101003969"
## [1] "Standard deviations from mean: 2.53914733930094"
## [1] ""
## [1] "oligodendrocytes"
## [1] 0.41
## [1] ""
## [1] "pyramidal CA1"
## [1] 0.69
## [1] ""
## [1] "pyramidal SS"
## [1] 0.51
## [1] ""</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_res1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">unconditional_results</span><span class="op">$</span><span class="va">results</span>,list<span class="op">=</span><span class="st">"Unconditional Enrichment"</span><span class="op">)</span>
<span class="va">full_res2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">conditional_results_micro</span><span class="op">$</span><span class="va">results</span>,list<span class="op">=</span><span class="st">"Conditional Enrichment (Microglia controlled)"</span><span class="op">)</span>
<span class="va">full_res3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">conditional_results_astro</span><span class="op">$</span><span class="va">results</span>,list<span class="op">=</span><span class="st">"Conditional Enrichment (Astrocyte controlled)"</span><span class="op">)</span>
<span class="va">merged_results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">full_res1</span>,<span class="va">full_res2</span><span class="op">)</span>,<span class="va">full_res3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/ewce.plot.html">ewce.plot</a></span><span class="op">(</span>total_res<span class="op">=</span><span class="va">merged_results</span>,mtc_method<span class="op">=</span><span class="st">"BH"</span><span class="op">)</span><span class="op">$</span><span class="va">plain</span><span class="op">)</span></code></pre></div>
<p><img src="EWCE_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<p>When controlling for astrocytes the enrichment is astrocytes is totally abolished as expected, and vica versa. The enrichment in microglia remains strongly significant however after controlling for microglia, suggesting that this enrichment is independent of that in astrocytes.</p>
</div>
<div id="gene-set-enrichment-analysis-controlling-for-cell-type-expression" class="section level2">
<h2 class="hasAnchor">
<a href="#gene-set-enrichment-analysis-controlling-for-cell-type-expression" class="anchor"></a>Gene set enrichment analysis controlling for cell type expression</h2>
<p>Traditionally the standard analysis run on all gene sets was the GO enrichment analysis. Once you have established that a given gene list is enriched for a given celltype, it becomes questionable whether a GO enrichment is driven purely by the underlying cell type enrichment. For instance, it is well established that genes associated with schizophrenia are enriched for the human post-synaptic density genes, however, it has also been shown that schizophrenia is enriched for specificity in CA1 pyramidal neurons (which highly express hPSD genes). These two enrichments can be disassociated using the following analysis:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"mouse_to_human_homologs"</span><span class="op">)</span>
<span class="va">m2h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">mouse_to_human_homologs</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HGNC.symbol"</span>,<span class="st">"MGI.symbol"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"schiz_genes"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"id_genes"</span><span class="op">)</span>
<span class="va">mouse.hits.schiz</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">[</span><span class="va">m2h</span><span class="op">$</span><span class="va">HGNC.symbol</span> <span class="op">%in%</span> <span class="va">schiz_genes</span>,<span class="st">"MGI.symbol"</span><span class="op">]</span><span class="op">)</span>
<span class="va">mouse.hits.id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">[</span><span class="va">m2h</span><span class="op">$</span><span class="va">HGNC.symbol</span> <span class="op">%in%</span> <span class="va">id_genes</span>,<span class="st">"MGI.symbol"</span><span class="op">]</span><span class="op">)</span>
<span class="va">mouse.bg</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">$</span><span class="va">MGI.symbol</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"hpsd_genes"</span><span class="op">)</span>
<span class="va">mouse.hpsd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">m2h</span><span class="op">[</span><span class="va">m2h</span><span class="op">$</span><span class="va">HGNC.symbol</span> <span class="op">%in%</span> <span class="va">hpsd_genes</span>,<span class="st">"MGI.symbol"</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"rbfox_genes"</span><span class="op">)</span>

<span class="va">res_hpsd_schiz</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.schiz</span>, functional_genes <span class="op">=</span> <span class="va">mouse.hpsd</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="st">"pyramidal CA1"</span><span class="op">)</span>
<span class="va">res_rbfox_schiz</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.schiz</span>, functional_genes <span class="op">=</span> <span class="va">rbfox_genes</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="st">"pyramidal CA1"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_hpsd_schiz</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_rbfox_schiz</span><span class="op">)</span>

<span class="va">res_hpsd_id</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.id</span>, functional_genes <span class="op">=</span> <span class="va">mouse.hpsd</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="st">"pyramidal SS"</span><span class="op">)</span>
<span class="va">res_rbfox_id</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.id</span>, functional_genes <span class="op">=</span> <span class="va">rbfox_genes</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="st">"pyramidal SS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_hpsd_id</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_rbfox_id</span><span class="op">)</span></code></pre></div>
<p>The analysis also tests for enrichment of Rbfox binding genes in the schizophrenia susceptibility genes, as well as both hPSD and Rbfox genes in Intellectual Disability genes. All of the enrichments are confirmed as still being present after controlling for the associated cell type, apart from the enrichment of PSD genes in Schizophrenia which falls from borderline to non-significant.</p>
</div>
<div id="controlling-for-multiple-cell-types" class="section level2">
<h2 class="hasAnchor">
<a href="#controlling-for-multiple-cell-types" class="anchor"></a>Controlling for multiple cell types</h2>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">controlledCTs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pyramidal CA1"</span>,<span class="st">"pyramidal SS"</span>,<span class="st">"interneurons"</span><span class="op">)</span>

<span class="va">res_hpsd_schiz</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.schiz</span>, functional_genes <span class="op">=</span> <span class="va">mouse.hpsd</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="va">controlledCTs</span><span class="op">)</span>
<span class="va">res_rbfox_schiz</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.schiz</span>, functional_genes <span class="op">=</span> <span class="va">rbfox_genes</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="va">controlledCTs</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_hpsd_schiz</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_rbfox_schiz</span><span class="op">)</span>

<span class="va">res_hpsd_id</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.id</span>, functional_genes <span class="op">=</span> <span class="va">mouse.hpsd</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="va">controlledCTs</span><span class="op">)</span>
<span class="va">res_rbfox_id</span> <span class="op">=</span> <span class="fu"><a href="../reference/controlled_geneset_enrichment.html">controlled_geneset_enrichment</a></span><span class="op">(</span>disease_genes<span class="op">=</span><span class="va">mouse.hits.id</span>, functional_genes <span class="op">=</span> <span class="va">rbfox_genes</span>, bg_genes <span class="op">=</span> <span class="va">mouse.bg</span>, sct_data <span class="op">=</span> <span class="va">ctd</span>, annotLevel <span class="op">=</span> <span class="fl">1</span>, reps<span class="op">=</span><span class="va">reps</span>, controlledCT<span class="op">=</span><span class="va">controlledCTs</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_hpsd_id</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res_rbfox_id</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references csl-bib-body" line-spacing="2">
<div id="ref-skene_2016" class="csl-entry">
<div class="csl-left-margin">1. </div>
<div class="csl-right-inline">Skene, N. &amp; Grant, S. Identification of vulnerable cell types in major brain disorders using single cell transcriptomes and expression weighted cell type enrichment. <em>Frontiers in Neuroscience</em> (2016). doi:<a href="https://doi.org/10.3389/fnins.2016.00016">10.3389/fnins.2016.00016</a>
</div>
</div>
<div id="ref-zeisel2015cell" class="csl-entry">
<div class="csl-left-margin">2. </div>
<div class="csl-right-inline">Zeisel, A. <em>et al.</em> Cell types in the mouse cortex and hippocampus revealed by single-cell RNA-seq. <em>Science</em> <strong>347,</strong> 1138–1142 (2015).</div>
</div>
<div id="ref-haroutunian2009transcriptional" class="csl-entry">
<div class="csl-left-margin">3. </div>
<div class="csl-right-inline">Haroutunian, V., Katsel, P. &amp; Schmeidler, J. Transcriptional vulnerability of brain regions in alzheimer’s disease and dementia. <em>Neurobiology of aging</em> <strong>30,</strong> 561–573 (2009).</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alan Murphy, Nathan Skene.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
