---
title: "Getting started"
author: "<h4>Alan Murphy, Brian Schilder, and Nathan Skene</h4>"
date: "<h4>`r format( Sys.Date(), '%b-%d-%Y')`</h4>"
bibliography: ../inst/cit/EWCE.bib
csl: ../inst/cit/nature.csl
output:
  BiocStyle::html_document:
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

# Introduction

The `EWCE` R package is designed to facilitate expression weighted cell type
enrichment analysis as described in our *Frontiers in Neuroscience* 
paper [@skene_2016]. `EWCE` can be applied to any gene list. 
 
Using `EWCE` essentially involves two steps:

1. Prepare a single-cell reference; i.e. CellTypeDataset (CTD). Alternatively, 
you can use one of the pre-generated CTDs we provide via the package `ewceData`
(which comes with `EWCE`).  
2. Run cell type enrichment on a gene list using the `bootstrap_enrichment_test` function. 

# Setup

```{r setup, include=TRUE}
library(EWCE) 
set.seed(1234)
```

# 1. Prepare input data

## CellTypeDataset

Load a CTD previously generated from mouse cortex and hypothalamus single-cell RNA-seq data (from the Karolinska Institute). 

```{r}
ctd <- ewceData::ctd()
```

## Plot CTD mean_exp

Plot the expression of four markers genes across all cell types in the CTD.

```{r, fig.width=7, fig.height=5}
plt_exp <- EWCE::plot_ctd(ctd = ctd,
                          level = 1,
                          genes = c("Apoe","Gfap","Gapdh"),
                          metric = "mean_exp")
```
```{r, fig.width=9, fig.height=5}
plt_spec <- EWCE::plot_ctd(ctd = ctd,
                           level = 2,
                           genes = c("Apoe","Gfap","Gapdh"),
                           metric = "specificity")
```


## Gene list

Gene lists input into *EWCE*  can comes from any source (e.g. GWAS, candidate genes, pathways). 

Here, we provide an example gene list of Alzheimer's disease-related nominated from a GWAS.

```{r}
hits <- ewceData::example_genelist()
print(hits)
```

 
# 2. Run cell type enrichment tests

We now run the cell type enrichment tests on the gene list. Since the CTD is from mouse data (and is annotated using mouse genes) we specify the argument `sctSpecies="mouse"`. `bootstrap_enrichment_test` will automaticlaly convert the mouse genes to human genes.

Since the gene list came from GWAS in humans, we set `genelistSpecies="human"`.

*Note*: We set the seed at the top of this vignette to
ensure reproducibility in the bootstrap sampling function.

### Hyperparameters

*Note*: We use 100 repetitions here for the purposes of a quick example, but in practice you would want to use `reps=10000` for publishable results.

```{r}
reps <- 100
annotLevel <- 1
```

```{r }
full_results <- EWCE::bootstrap_enrichment_test(sct_data = ctd,
                                                sctSpecies = "mouse",
                                                genelistSpecies = "human",
                                                hits = hits, 
                                                reps = reps,
                                                annotLevel = annotLevel)
```

 

The main table of results is stored in `full_results$results`.

In this case, microglia were the only cell type that was significantly enriched in the Alzheimer's disease gene list.

```{r }
knitr::kable(full_results$results)
```

The results can be visualised using another function, which shows for each cell type, the number of standard deviations from the mean the level of expression was found to be in the target gene list, relative to the bootstrapped mean.

The dendrogram at the top shows how the cell types are hierarchically clustered by transcriptional similarity.
 
```{r }
plot_list <- EWCE::ewce_plot(total_res = full_results$results,
                             mtc_method = "BH",
                             ctd = ctd)
print(plot_list$withDendro)
```
     
# Session Info

<details>

```{r Session Info}
utils::sessionInfo()
```

</details>


# References

